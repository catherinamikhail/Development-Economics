---
title: "Group Data Assignment Week 3"
author: "Catherina Mikhail 2847118, Sinem Göral 2817932, Ela Köycü 2846357"
date: "2025-11-12"
output:
  word_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,      
  warning = FALSE, 
  message = FALSE,  
  results = 'markup' 
)
# First we need to make sure that some packages (=places where e.g. commands are 
#saved) are available, for this, we need to install them
#for this, we create a variable called check, (see in your Enviroment 
#what value it takes after having run the line), it takes TRUE if the package is 
#already installed and FALSE if not
check <- require('survey')
#next, we have a loop that has a condition (!check, this condition is TRUE if check is FALSE and FALSE if check is TRUE)
#i.e. if it is already installed, the loop will not do anything, if it is not instaled, it will install it
#Depending on your version, you might need to enter YES in the console to confirm that you want to install it
if(!check) {
     install.packages('survey')
}
#just because it is installed does not mean that it is loaded into your current session (the one you run this file in), therefore we execute the following code
library(survey)  
#to learn about the package
?survey

#now to the next package that will allow us to load the files we have easily into R
check <- require('readstata13')
#if not installed, install the package, this needs to be confirmed by typing in yes in the command console, after having run the following line
if(!check) {
       install.packages('readstata13')
     }
library('readstata13')  
#to learn about the package
?readstata13

#some housekeeping
rm(check)

# now finally: Read in data

#for this: we create the filepath either per hand, see the line below, 
#or we use the point-and-shoot-option (often easier if you donot feel comfortable with R or coding yet)

#statafile <- 'u:/interim files/Tanzania 2012.dta' #if you want to use this, delete the # at the beginning and type in the correct path
statafile2012 <- file.choose() #allows for clicking on it in a window, no need to have the path ready, click here on the file "Tanzania_2012.dta"
#load it
statafile2018 <- file.choose() #click here on the file "Tanzania_2018.dta"
tzdata2012 <- read.dta13(statafile2012,nonint.factors = T)
tzdata2018 = read.dta13(statafile2018,nonint.factors = T)
  
# Remove observations with missing data 
tzdata2012 <- na.omit(tzdata2012)
tzdata2018 <- na.omit(tzdata2018)
#create population-weight (popwt) as a variable
tzdata2012$popwt <- with(tzdata2012,hhsize*hhweight)
tzdata2018$popwt <- with(tzdata2018,hhsize*hhweight)
                          
#incorporate the surveydesign: for this, use the information about strata, weights and ID from the data
tzdesign2012 <- svydesign(id = ~CLUSTER, strata = ~STRATUM, weights = ~popwt, nest =T,  data = tzdata2012)
tzdesign2018 <- svydesign(id = ~CLUSTER, strata = ~STRATUM, weights = ~popwt, nest = T, data = tzdata2018)
#

#This is the end for the first round of the survey (either 2012 and 2018), 
#now you will have to repeat the code for the other round, however, no need to load (or install) the packages again, good luck!

```

1.a. Using the data files on Tanzania, we have computed the headcount, poverty gap and squared poverty gap on the national level.

-   We used the formula H = q/N, where q is the amount of people considered poor and N the total population. For 2012 we discovered that around 28.17% of the population is considered poor using the headcount method. For 2018 we discovered that around 26.39% of the population is considered poor using the headcount method.

```{r Headcount National, echo=TRUE}
## National headcount for 2012
# First we determine which households are poor by looking at who's consumption is below the poverty line
tzdata2012$poor <- ifelse(tzdata2012$cons <= tzdata2012$povline, 1, 0)
# Then we calculate the amount of people those households represent
sum(tzdata2012$popwt * tzdata2012$poor, na.rm = TRUE)
# Then we calculate the headcount H = q/N
sum(tzdata2012$popwt * tzdata2012$poor, na.rm = TRUE)/sum(tzdata2012$popwt)

## National headcount for 2012
# First we determine which households are poor by looking at who's consumption is below the poverty line
tzdata2018$poor <- ifelse(tzdata2018$cons <= tzdata2018$povline, 1, 0)
# Then we calculate the amount of people those households represent
sum(tzdata2018$popwt * tzdata2018$poor, na.rm = TRUE)
# Then we calculate the headcount H = q/N
sum(tzdata2018$popwt * tzdata2018$poor, na.rm = TRUE)/sum(tzdata2018$popwt)
```

-   We used the formula 1/N \* sum(q \* (z / (z - y))), where z is the poverty line and y is consumption, to compute the poverty gap. For 2012 we discovered that the average poor person is falling short of the poverty line by 6.70%. For 2018 we discovered that the average poor person is falling short of the poverty line by 6.16%.

```{r Poverty Gap National, echo=TRUE}
## National Poverty Gap for 2012
# First we determine the gap ratio = (poverty line - consumption)/poverty line for all people considered poor
tzdata2012$gapratio <- with(tzdata2012, (povline-cons)/povline * tzdata2012$poor)
# Then we calculate the poverty gap by PG= 1/N * (gap ratio * weighted population)
(1/sum(tzdata2012$popwt)) * sum(tzdata2012$gapratio * tzdata2012$popwt)

## National Poverty Gap for 2018
# First we determine the gap ratio = (poverty line - consumption)/poverty line for all people considered poor
tzdata2018$gapratio <- with(tzdata2018, (povline-cons)/povline * tzdata2018$poor)
# Then we calculate the poverty gap by PG= 1/N * (gap ratio * weighted population)
(1/sum(tzdata2018$popwt)) * sum(tzdata2018$gapratio * tzdata2018$popwt)

```

-   We used the formula 1/N \* sum(q \* ((z / (z - y))\^2)) to compute the squared poverty gap. For 2012 we discovered that on average, the income shortfall of poor households relative to the poverty line is 12.82% when giving greater weight to the poorest. For 2018 this was 11.83%.

```{r Squared Povert Gap National, echo=TRUE}
## National Poverty Gap for 2012
# First we determine the square gap ratio = (poverty line - consumption)/poverty)^2 / poverty line for all people considered poor
tzdata2012$squaregapratio <- with(tzdata2012, (sqrt((povline-cons)/povline * tzdata2012$poor)))
# Then we calculate the square poverty gap by PG= 1/N * (square gap ratio * weighted population)
(1/sum(tzdata2012$popwt)) * sum(tzdata2012$squaregapratio * tzdata2012$popwt)

## National Poverty Gap for 2018
# First we determine the square gap ratio = (poverty line - consumption)/poverty)^2 / line for all people considered poor
tzdata2018$squaregapratio <- with(tzdata2018, (sqrt((povline-cons)/povline * tzdata2018$poor)))
# Then we calculate the square poverty gap by PG= 1/N * (square gap ratio * weighted population)
(1/sum(tzdata2018$popwt)) * sum(tzdata2018$squaregapratio * tzdata2018$popwt)
```

1.b. Using the data files on Tanzania, we have computed the headcount, poverty gap and squared poverty gap on the area level.

-   Looking at the headcount per area we have discovered for 2012 33.29% in rural areas, 21.69% in urban areas and 4.11% in Dar es Salaam are considered poor. For 2018 31.35% in rural areas, 19.22% in urban areas and 7.98% in Dar es Salaam is considered poor.

```{r Headcount Area, echo=TRUE}
# Headcount per area 2012
library(tidyverse)
tzdata2012 %>%
  group_by(STRATUM) %>%
  summarise(headcount = sum(popwt * poor, na.rm = TRUE)/sum(popwt))
# Headcount per area 2018
tzdata2018 %>%
  group_by(STRATUM) %>%
  summarise(headcount = sum(popwt * poor, na.rm = TRUE)/sum(popwt))
```

-   Computing the poverty gap per area we found out that for 2012 the average poor person is falling short of the poverty line by 7.84% in rural areas, 5.51% in urban areas and 0.83% in Dar es Salaam. For 2018 the average poor person is falling short of the poverty line by 7.40% in rural areas, 4.16% in urban areas and 2.03% in Dar es Salaam.

```{r Poverty Gap Area, echo=TRUE}
# Poverty gap per area 2012
tzdata2012 %>%
  group_by(STRATUM) %>%
  summarise(poverty_gap = (1/sum(popwt)) * sum(gapratio * popwt))
# Poverty gap per area 2012
tzdata2018 %>%
  group_by(STRATUM) %>%
  summarise(poverty_gap = (1/sum(popwt)) * sum(gapratio * popwt))
```

-   Computing the squared poverty gap per area we discovered that for 2012 on average, the income shortfall of poor households relative to the poverty line is 15.11% in rural areas, 10.09% in urban areas and 1.69% in Dar es Salaam. For 2018 on average, the income shortfall of poor households relative to the poverty line is 14.14% in rural areas, 8.22% in urban areas and 3.84% in Dar es Salaam.

```{r Squared Poverty Gap Area, echo=TRUE}
# Squared poverty gap per area 2012
tzdata2012 %>%
  group_by(STRATUM) %>%
  summarise(squared_poverty_gap = (1/sum(popwt)) * sum(squaregapratio * popwt))
# Squared poverty gap per area 2018
tzdata2018 %>%
  group_by(STRATUM) %>%
  summarise(squared_poverty_gap = (1/sum(popwt)) * sum(squaregapratio * popwt))
```

1.c. Using the data files on Tanzania, we have computed the headcount, poverty gap and squared poverty gap on the region level.

-   Looking at the headcount per area we have discovered for 2012 34.60% in Dodoma, 21.89% in Arusha, 11.38% in Kilimanjaro, 30.74% in Tanga, 11.13% in Morogoro, 16.01% in Pwani, 4.11% in Dar es Salaam, 17.74% in Lindi, 41.39% in Mtwara and 53.65% in Ruvumaare considered poor. For 2018 23.19% in Dodoma, 24.65% in Arusha, 10.52% in Kilimanjaro, 20.95% in Tanga, 19.31% in Morogoro, 27.88% in Pwani, 7.98% in Dar es Salaam, 38.01% in Lindi, 29.14% in Mtwara and 30.60% in Ruvumaare considered poor.

```{r Headcount Region, echo=TRUE}
# Headcount per region 2012
tzdata2012 %>%
  group_by(region) %>%
  summarise(headcount = sum(popwt * poor, na.rm = TRUE)/sum(popwt))
# Headcount per region 2018
tzdata2018 %>%
  group_by(region) %>%
  summarise(headcount = sum(popwt * poor, na.rm = TRUE)/sum(popwt))
```

-   Computing the poverty gap per area we found out that for 2012 the average poor person is falling short of the poverty line by 7.09% in Dodoma, 6.02% in Arusha, 1.81% in Kilimanjaro, 6.78% in Tanga, 2.38% in Morogoro, 3.53% in Pwani, 0.82% in Dar es Salaam, 2.19% in Lindi, 11.83% in Mtwara and 15.55% in Ruvumaare considered poor. For 2018 the average poor person is falling short of the poverty line by 4.05% in Dodoma, 5.75% in Arusha, 1.66% in Kilimanjaro, 5.06% in Tanga, 3.68% in Morogoro, 8.73% in Pwani, 2.03% in Dar es Salaam, 9.58% in Lindi, 5.93% in Mtwara and 6.69% in Ruvumaare considered poor.

```{r Poverty Gap Region, echo=TRUE}
# Poverty gap per region 2012
tzdata2012 %>%
  group_by(region) %>%
  summarise(poverty_gap = (1/sum(popwt)) * sum(gapratio * popwt))
# Poverty gap per region 2018
tzdata2018 %>%
  group_by(region) %>%
  summarise(poverty_gap = (1/sum(popwt)) * sum(gapratio * popwt))
```

-   Computing the squared poverty gap per area we discovered that for 2012 on average, the income shortfall of poor households relative to the poverty line is 14.65% in Dodoma, 10.70% in Arusha, 4.12% in Kilimanjaro, 13.52% in Tanga, 4.78% in Morogoro, 6.92% in Pwani, 1.69% in Dar es Salaam, 5.70% in Lindi, 20.17% in Mtwara and 26.99% in Ruvumaare. For 2018 on average, the income shortfall of poor households relative to the poverty line is 8.82% in Dodoma, 11.07% in Arusha, 3.83% in Kilimanjaro, 9.62% in Tanga, 7.75% in Morogoro, 14.81% in Pwani, 3.84% in Dar es Salaam, 18.01% in Lindi, 11.75% in Mtwara and 13.22% in Ruvumaare.

```{r Squared Poverty Gap Region, echo=TRUE}
# Squared poverty gap per region 2012
tzdata2012 %>%
  group_by(region) %>%
  summarise(squared_poverty_gap = (1/sum(popwt)) * sum(squaregapratio * popwt))
# Squared poverty gap per region 2018
tzdata2018 %>%
  group_by(region) %>%
  summarise(squared_poverty_gap = (1/sum(popwt)) * sum(squaregapratio * popwt))
```
3. We have computed the stratum- and region-level contribution to the national headcount rate. 

- The area level contribution to the national headcount rate for 2012 is 33.29% in rural areas, 21.69% in urban areas and 4.11% in Dar es Salaam. For 2018 the contribution to the national headcount rate is 31.35% in rural areas, 19.22% in urban areas and 7.98% in Dar es Salaam.
```{r stratum level contribution}
# stratum level contribution 2012
tzdata2012 %>%
  group_by(STRATUM) %>%
  summarise(contribution = ((sum(popwt * poor))/sum(popwt)) * 100)
# stratum level contribution 2018
tzdata2018 %>%
  group_by(STRATUM) %>%
  summarise(contribution = ((sum(popwt * poor))/sum(popwt)) * 100)
```
- The region level contribution to the national headcount rate for 2012 is 34.60% in Dodoma, 21.89% in Arusha,	11.38% in Kilimanjaro, 30.74% in Tanga, 11.13% in Morogoro, 16.01% in Pwani, 4.11% in Dar Es Salaam, 17.74% in Lindi, 41.39% in Mtwara and 53.65 in Ruvuma. For 2018 is 23.19% in Dodoma, 24.65% in Arusha,	10.52% in Kilimanjaro, 20.95% in Tanga, 19.31% in Morogoro, 27.88% in Pwani, 7.98% in Dar Es Salaam, 38.01% in Lindi, 29.14% in Mtwara and 30.60 in Ruvuma.  
```{r region level contribution}
# region level contribution 2012
tzdata2012 %>%
  group_by(region) %>%
  summarise(contribution = ((sum(popwt * poor))/sum(popwt)) * 100)
# region level contribution 2018
tzdata2018 %>%
  group_by(region) %>%
  summarise(contribution = ((sum(popwt * poor))/sum(popwt)) * 100)
```

